## コールバックの実装方法
コールバックとは、オブジェクトのライフサイクルの特定の瞬間に呼び出されるメソッドのことです。コールバックを利用すれば、`Active Record`オブジェクトが作成、保存、更新、削除された時などの任意のタイミングで、常にその処理が実行されるようにコードを書くことができます。

### Railsアプリの用意

まずは、今回の項目で使うアプリの準備です。  
アプリ名を`callback_app`として立ち上げ、Userモデルをscaffoldで作成しましょう。  
その時、以下の2つのカラムを追加してください。

* `name (string型)`
* `age (integer型)`

`実行例`
```
rails new callback_app -d postgresql
rails generate scaffold user name:string age:integer
rails db:create
rails db:migrate
```

### コールバックの実装
さっそくコールバックの定義方法について学んでいきましょう。  
コールバックの定義にはいくつか方法があります。

#### プライベートメソッドを定義して呼び出す方法
例として、nameカラムに初期値を持たせる処理を書いてみましょう。  
nameの値に何も設定せず`create`した場合、初期値として`Taro`を保管するメソッドを作成します。

`app/models/user.rb`

```rb
class User < ActiveRecord::Base

  private
  def ensure_has_name
    self.name = 'Taro' if name.blank?
  end
end
```

このメソッドを作成の直前にコールバックされるよう、登録します。

`app/models/user.rb`
```rb
class User < ActiveRecord::Base
  before_create :ensure_has_name

  private
  def ensure_has_name
    self.name = 'Taro' if name.blank?
  end
end
```

コールバック処理の設定は以上で完了です。
早速処理を確認してみましょう。

```
$ rails c
> User.create
   (0.1ms)  begin transaction
  SQL (0.5ms)  INSERT INTO "users" ("created_at", "updated_at", "name") VALUES (?, ?, ?)  [["created_at", "2017-08-20 09:31:27.891895"], ["updated_at", "2017-08-20 09:31:27.891895"], ["name", "Taro"]]
   (10.0ms)  commit transaction
 => #<User id: 1, name: "Taro", age: nil, created_at: "2017-08-20 09:31:27", updated_at: "2017-08-20 09:31:27">
```

nameの値には何も指定していませんが、コールバック処理が動いたことで`Taro`という値が入って保存されています。

#### ブロック形式で定義する方法
コールバックメソッドはブロック形式で定義することもできます。
この形式では、引数としてコールバックの種類によって任意の値を受け取ることができます。

今回は`after_initialize`コールバックを使用してみましょう。
`after_initialize`は、`Active Record`オブジェクトがインスタンス化されるたびに呼び出されるコールバックです。

`app/models/user.rb`

```rb
class User < ActiveRecord::Base
  before_create :ensure_has_name

  after_initialize do |user|
    puts "オブジェクトを生成しました！"
  end
# 省略
```

実際にUserモデルのインスタンスを生成してみましょう。

```
$ rails c
> User.new
オブジェクトを生成しました！
 => #<User id: nil, name: nil, age: nil, created_at: nil, updated_at: nil>
```

after_initializeコールバックが呼び出されているのが確認できると思います。
